name: Load Server Machine Dataset
description: Loads the SMD dataset and saves train, test, and anomaly CSVs.

outputs:
  - name: train_csv
    type: Path
  - name: test_csv
    type: Path
  - name: anomaly_csv
    type: Path

implementation:
  container:
    image: python:3.9
    command:
      - sh
      - -c
      - |
        set -e
        # Install git, wget, unzip and Python packages including requests
        apt-get update && apt-get install -y git wget unzip
        PIP_DISABLE_PIP_VERSION_CHECK=1 python3 -m pip install --quiet pandas numpy requests
        exec "$0" "$@"
      - python3
      - -u
      - -c
      - |
        import argparse
        import os
        import pandas as pd
        import requests, zipfile, io

        parser = argparse.ArgumentParser()
        parser.add_argument('--train_csv', type=str, required=True)
        parser.add_argument('--test_csv', type=str, required=True)
        parser.add_argument('--anomaly_csv', type=str, required=True)
        args = parser.parse_args()

        # Download SMD dataset if not exists
        smd_path = "/tmp/omni/data/SMD"
        if not os.path.exists(smd_path):
            os.makedirs(smd_path, exist_ok=True)
            url = "https://github.com/NetManAIOps/OmniAnomaly/raw/master/data/SMD/SMD.zip"
            r = requests.get(url)
            z = zipfile.ZipFile(io.BytesIO(r.content))
            z.extractall(smd_path)

        dataset_path = os.path.join(smd_path, "train")
        csv_files = [os.path.join(dataset_path, f) for f in os.listdir(dataset_path) if f.endswith(".csv") or f.endswith(".txt")]
        if not csv_files:
            raise FileNotFoundError(f"No CSV/TXT files found in {dataset_path}")

        df_list = [pd.read_csv(f, header=None) for f in sorted(csv_files)]
        df = pd.concat(df_list, ignore_index=True)

        # Example split: train/test/anomaly
        train_df = df.sample(frac=0.7, random_state=42)
        test_df = df.drop(train_df.index)
        anomaly_df = df[df.iloc[:, -1] == 1] if df.shape[1] > 1 else pd.DataFrame()

        # Ensure output dirs exist
        os.makedirs(args.train_csv, exist_ok=True)
        os.makedirs(args.test_csv, exist_ok=True)
        os.makedirs(args.anomaly_csv, exist_ok=True)

        # Save CSV files
        train_df.to_csv(os.path.join(args.train_csv, "data"), index=False)
        test_df.to_csv(os.path.join(args.test_csv, "data"), index=False)
        anomaly_df.to_csv(os.path.join(args.anomaly_csv, "data"), index=False)

        print(f"[SUCCESS] Train CSV: {os.path.join(args.train_csv, 'data')}")
        print(f"[SUCCESS] Test CSV: {os.path.join(args.test_csv, 'data')}")
        print(f"[SUCCESS] Anomaly CSV: {os.path.join(args.anomaly_csv, 'data')}")

    args:
      - --train_csv
      - {outputPath: train_csv}
      - --test_csv
      - {outputPath: test_csv}
      - --anomaly_csv
      - {outputPath: anomaly_csv}
